<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Jerry Will's Blog – Flink</title><link>/note/bigdata/flink/</link><description>Recent content in Flink on Jerry Will's Blog</description><generator>Hugo -- gohugo.io</generator><language>zh-cn</language><atom:link href="/note/bigdata/flink/index.xml" rel="self" type="application/rss+xml"/><item><title>Note: Flink Code</title><link>/note/bigdata/flink/flink-code/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>/note/bigdata/flink/flink-code/</guid><description>
&lt;h2 id="flink-client">&lt;code>flink-client&lt;/code>&lt;/h2>
&lt;h3 id="clifrontend">CliFrontend&lt;/h3>
&lt;blockquote>
&lt;p>build StreamGraph&lt;/p>
&lt;p>org.apache.flink.client.cli.CliFrontend#main&lt;/p>
&lt;/blockquote>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#000">FLINK_CONF_DIR&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>./flink-dist/src/main/resources
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#8f5902;font-style:italic"># submit a job&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>run ./flink-examples/flink-examples-streaming/target/WordCount.jar
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="flink-runtime">&lt;code>flink-runtime&lt;/code>&lt;/h2>
&lt;h3 id="standalonesessionclusterentrypoint">StandaloneSessionClusterEntrypoint&lt;/h3>
&lt;blockquote>
&lt;p>run JobManager&lt;/p>
&lt;p>org.apache.flink.runtime.entrypoint.StandaloneSessionClusterEntrypoint&lt;/p>
&lt;/blockquote>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>-c ./flink-dist/src/main/resources
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>Note: Flink Deploy</title><link>/note/bigdata/flink/flink-deploy/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>/note/bigdata/flink/flink-deploy/</guid><description>
&lt;h2 id="cluster">Cluster&lt;/h2>
&lt;h3 id="starting-a-session-cluster-on-docker">Starting a Session Cluster on Docker&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#8f5902;font-style:italic"># https://ci.apache.org/projects/flink/flink-docs-master/docs/deployment/resource-providers/standalone/docker/#starting-a-session-cluster-on-docker&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#000">FLINK_PROPERTIES&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;jobmanager.rpc.address: flink-jobmanager&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>docker network create flink
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#8f5902;font-style:italic"># launch the JobManager&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>docker run -d &lt;span style="color:#4e9a06">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#4e9a06">&lt;/span> --name&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>flink-jobmanager &lt;span style="color:#4e9a06">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#4e9a06">&lt;/span> --network flink &lt;span style="color:#4e9a06">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#4e9a06">&lt;/span> --publish 8081:8081 &lt;span style="color:#4e9a06">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#4e9a06">&lt;/span> --env &lt;span style="color:#000">FLINK_PROPERTIES&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;&lt;/span>&lt;span style="color:#4e9a06">${&lt;/span>&lt;span style="color:#000">FLINK_PROPERTIES&lt;/span>&lt;span style="color:#4e9a06">}&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;&lt;/span> &lt;span style="color:#4e9a06">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#4e9a06">&lt;/span> flink jobmanager
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#8f5902;font-style:italic"># one or more TaskManager containers &lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>docker run -d &lt;span style="color:#4e9a06">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#4e9a06">&lt;/span> --name&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>flink-taskmanager1 &lt;span style="color:#4e9a06">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#4e9a06">&lt;/span> --network flink &lt;span style="color:#4e9a06">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#4e9a06">&lt;/span> --env &lt;span style="color:#000">FLINK_PROPERTIES&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;&lt;/span>&lt;span style="color:#4e9a06">${&lt;/span>&lt;span style="color:#000">FLINK_PROPERTIES&lt;/span>&lt;span style="color:#4e9a06">}&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;&lt;/span> &lt;span style="color:#4e9a06">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#4e9a06">&lt;/span> flink taskmanager
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#8f5902;font-style:italic"># submit a task &lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>./bin/flink run ./examples/streaming/TopSpeedWindowing.jar
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>Note: Flink Principle</title><link>/note/bigdata/flink/flink-principle/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>/note/bigdata/flink/flink-principle/</guid><description>
&lt;h2 id="整体架构">整体架构&lt;/h2>
&lt;p>Flink系统由&lt;code>Flink Program&lt;/code>、&lt;code>JobManager&lt;/code>、&lt;code>TaskManager&lt;/code>三个部分组成。这三部分之间都使用Akka框架(&lt;code>Actor System&lt;/code>)进行通信, 通过发送消息驱动任务的推进。&lt;/p>
&lt;p>&lt;code>Flink Program&lt;/code> 加载用户提交的任务代码，解析并生成任务执行拓扑图，并将拓扑图提交给&lt;code>JobManager&lt;/code>。&lt;/p>
&lt;p>&lt;code>JobManager&lt;/code>基于任务执行拓扑图，生成相应的物理执行计划，将执行计划发送给&lt;code>TaskManager&lt;/code>执行。除此之外，&lt;code>JobManager&lt;/code>还负责协调&lt;code>checkpoint&lt;/code>的生成，不断地从&lt;code>TaskManager&lt;/code>收集Operator的状态，并周期性生成&lt;code>checkpoint&lt;/code>，以便在系统出错时从&lt;code>checkpoint&lt;/code>恢复之前的状态。&lt;/p>
&lt;p>&lt;code>TaskManager&lt;/code>负责管理任务执行所需的资源，执行具体的任务，并将任务产出的数据流传入给下一个任务。每个&lt;code>TaskManger&lt;/code>上运行一个jvm进程。每个&lt;code>TaskSlot&lt;/code>运行一个线程&lt;/p>
&lt;h2 id="一致性保证与出错处理">一致性保证与出错处理&lt;/h2>
&lt;p>分布式场景中，数据会丢失、会乱序、会重复。乱序的问题，结合&lt;code>Event Time&lt;/code> (表征事件发生的时间)与 &lt;code>Watermark&lt;/code>(表征何时数据已经完整的标识)解决。针对丢失和重复的问题，Flink通过分布式快照(&lt;code>distributed snapshot&lt;/code>),支持了&lt;code>Exactly Once&lt;/code>的一致性语义&lt;/p>
&lt;ul>
&lt;li>
&lt;h3 id="分布式快照">分布式快照&lt;/h3>
&lt;/li>
&lt;/ul>
&lt;p>Flink基于&lt;code>Chandy and Lamport&lt;/code>算法,实现分布式快照机制&lt;/p>
&lt;p>在正常的数据流中，Flink会周期性插入一种特殊的数据记录 - &lt;code>barrier&lt;/code>，当算子处理到&lt;code>barrier&lt;/code>的时候，会保存算子当前的状态到持久性存储。当算子包含多个输入的时候，需要对齐多个&lt;code>barrier&lt;/code>(align barriers)。当算子某个输入率先接收到&lt;code>barrier&lt;/code>的时候，会缓存该输入的后续数据，直到所有的输入都收到&lt;code>barrier&lt;/code>之后，才会触发状态备份操作，并输出&lt;code>barrier&lt;/code>到下游算子。&lt;/p>
&lt;p>除了备份各个算子的状态生成snapshot之外，对于sink还需要执行一步额外操作 —— 将结果写入外部设备。Flink通过两阶段提交的机制(2PC,two-phase commit), 来实现这个分布式事务。&lt;/p>
&lt;h2 id="流量控制">流量控制&lt;/h2>
&lt;p>下游的&lt;code>InputChannel&lt;/code>从上游的&lt;code>ResultPartition&lt;/code>接收数据的时候，会基于当前已经缓存的数据量，以及可申请到的&lt;code>LocalBufferPool&lt;/code>与&lt;code>NetworkBufferPool&lt;/code>，计算出一个&lt;code>Credit&lt;/code>值返回给上游。上游基于&lt;code>Credit&lt;/code>的值，来决定发送多少数据。&lt;code>Credit&lt;/code>就像信用卡额度一样，不能超支。当下游发生数据拥塞时，&lt;code>Credit&lt;/code>减少值为0，于是上游停止数据发送。拥塞压力不断向上游传导，形成反压。&lt;/p></description></item></channel></rss>